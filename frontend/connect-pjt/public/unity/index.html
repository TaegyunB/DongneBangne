<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Unity WebGL Player | WebGLTest</title>
  </head>
  <script></script>
  <body style="text-align: center; padding: 0; border: 0; margin: 0">
    <canvas
      id="unity-canvas"
      width="1280"
      height="720"
      tabindex="-1"
      style="width: 1920px; height: 1080px; background: #ffb780"
    ></canvas>
    <script src="Build/unity.loader.js"></script>
    <script>
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:
        var meta = document.createElement('meta')
        meta.name = 'viewport'
        meta.content =
          'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes'
        document.getElementsByTagName('head')[0].appendChild(meta)

        var canvas = document.querySelector('#unity-canvas')
        canvas.style.width = '100%'
        canvas.style.height = '100%'
        canvas.style.position = 'fixed'

        document.body.style.textAlign = 'left'
      }

      window.addEventListener('message', function (event) {
        try{

          if(typeof unityInstance !== 'undefined'){
            const data = JSON.parse(event.data);

            //console.log("Vue â†’ Unity ë©”ì‹œì§€ ìˆ˜ì‹ : ", data);
            
            const messageHandlers = {
              // webRTC
              "video-frame": () => {
                if(data.sender === "local"){
                  unityInstance.SendMessage("VueReceiver", "ReceiveLocalVideoFrame", data.data);
                }
                else if(data.sender === "remote"){
                  unityInstance.SendMessage("VueReceiver", "ReceiveRemoteVideoFrame", data.data);
                }
              },
              // ê²Œì„ ëŒ€ê¸°ë°©
              "local-user-info": () => {
                unityInstance.SendMessage("VueReceiver", "ReceiveLocalUserInfo", data.data);
                console.log("Vue â†’ Unity ìœ ì € ì •ë³´ ì „ì†¡: ", data.data);
              },
              "room-list": () => {
                unityInstance.SendMessage("VueReceiver", "ReceiveRoomList", data.data);
                console.log("Vue â†’ Unity ë°© ì •ë³´ ì „ì†¡: ", data.data);
              },
              "room-created": () => {
                unityInstance.SendMessage("VueReceiver", "ReceiveCreatedRoomInfo", data.data);
                console.log("Vue â†’ Unity ë°© ìƒì„±ì„± ì „ì†¡: ", data.data);
              },
              "join-room": () => {
                unityInstance.SendMessage("VueReceiver", "ReceiveJoinRoom", data.data);
                console.log("Vue â†’ Unity ë°© ì…ì¥ ì „ì†¡: ", data.data);
              },
              "leave-room": () => {
                unityInstance.SendMessage("VueReceiver", "ReceiveLeaveRoom", data.data);
                console.log("Vue â†’ Unity ë°© í‡´ì¥ ì „ì†¡: ", data.data);
              },
              "ready-answer": () => {
                unityInstance.SendMessage("VueReceiver", "ReceiveReadyAnswer", data.data);
                console.log("Vue â†’ Unity ê²Œì„ ì¤€ë¹„: ", data.data);
              },
              "users-info": () => {
                unityInstance.SendMessage("VueReceiver", "ReceiveRoomUsersInfo", data.data);
                console.log("Vue â†’ Unity ìœ ì € ì •ë³´ ì „ì†¡: ", data.data);
              },
              // ê²Œì„
              "game-start": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveGameStart", data.data);
                console.log("Vue â†’ Unity ê²Œì„ ì‹œì‘: ", data.data);
              },
              "round-question": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveRoundQuestion", data.data);
                console.log("Vue â†’ Unity ë¼ìš´ë“œ ë¬¸ì œ: ", data.data);
              },
              "round-end": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveRoundEnd", data.data);
                console.log("Vue â†’ Unity ë¼ìš´ë“œ ì¢…ë£Œ: ", data.data);
              },
              "game-end": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveGameEnd", data.data);
                console.log("Vue â†’ Unity ê²Œì„ ì¢…ë£Œ: ", data.data);
              },
              "answer-submit": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveAnswerSubmit", data.data);
                console.log("Vue â†’ Unity ì •ë‹µ ì œì¶œ: ", data.data);
              },
              "answer-result": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveAnswerResult", data.data);
                console.log("Vue â†’ Unity ì •ë‹µ ê²°ê³¼: ", data.data);
              },
              "answer-rejected": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveAnswerRejected", data.data);
                console.log("Vue â†’ Unity ì •ë‹µ ê±°ë¶€: ", data.data);
              },
              // ê²Œì„ íŒíŠ¸
              "hint-response": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveHintResponse", data.data);
                console.log("Vue â†’ Unity íŒíŠ¸ ì‘ë‹µ: ", data.data);
              },
              "hint-rejected": () =>{
                unityInstance.SendMessage("VueReceiver", "ReceiveHintRejected", data.data);
                console.log("Vue â†’ Unity íŒíŠ¸ ê±°ë¶€: ", data.data);
              },
              "error": () => {
                unityInstance.SendMessage("VueReceiver", "ReceiveError", data.data);
                console.log("Vue â†’ Unity ì—ëŸ¬ ì „ì†¡: ", data.data);
              }
            };
            
            if (messageHandlers[data.type]) {
              messageHandlers[data.type]();
            }
          }
        }
        catch(e){
          console.warn("ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ", e);
        }
        // console.log('ğŸ“¨ Vue â†’ Unity ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data)
        
        // if (typeof unityInstance !== 'undefined') {
        //   //console.log("ğŸ“¨ Vue â†’ Unity ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
        //   unityInstance.SendMessage('VueReceiver', 'ReceiveFromVue', event.data)
        // }
      })

      // Unityê°€ Vueë¡œ ë©”ì‹œì§€ ë³´ë‚¼ ë•Œ í˜¸ì¶œí•  í•¨ìˆ˜
      window.SendToVue = function (msg) {
        console.log("Unity â†’ Vue ë©”ì‹œì§€ ì „ì†¡: ", msg);
        parent.postMessage(msg, '*')
      }

      createUnityInstance(document.querySelector('#unity-canvas'), {
        dataUrl: 'Build/unity.data',
        frameworkUrl: 'Build/unity.framework.js',
        codeUrl: 'Build/unity.wasm',
        streamingAssetsUrl: 'StreamingAssets',
        companyName: 'DefaultCompany',
        productName: 'WebGLTest',
        productVersion: '1.0',
        // matchWebGLToCanvasSize: false, // Uncomment this to separately control WebGL canvas render size and DOM element size.
        // devicePixelRatio: 1, // Uncomment this to override low DPI rendering on high DPI displays.
      })
        .then(function (instance) {
          unityInstance = instance
          parent.postMessage(JSON.stringify({ type: 'unity-ready' }), '*')
        })
        .catch(function (message) {
          alert(message)
        })
    </script>
  </body>
</html>
